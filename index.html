<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해양대 AI 비서 ARA v2.0</title>
    <style>
        :root { --primary-color: #005eb8; --bg-color: #f4f7f6; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 12px 16px; border-radius: 15px; line-height: 1.5; word-wrap: break-word; font-size: 15px; }
        .user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 2px; }
        .ara { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .input-area { background: white; padding: 20px; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        #chat-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        #chat-input:focus { border-color: var(--primary-color); }
        button { padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>
    <div id="chat-box"></div>
    <div class="input-area">
        <input type="text" id="chat-input" placeholder="선장님, 궁금한 게 있으신가요?" onkeypress="if(event.keyCode==13) sendMessage()">
        <button id="send-btn" onclick="sendMessage()">전송</button>
    </div>

    <script>
        // 1. 세션 유지: 브라우저 세션 동안 동일한 대화 맥락 유지
        let sessionId = sessionStorage.getItem('ara_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('ara_session_id', sessionId);
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const btn = document.getElementById('send-btn');
            const message = input.value.trim();
            if (!message) return;

            // UI 업데이트: 사용자 메시지
            addMessage('user', message);
            input.value = '';
            input.disabled = true;
            btn.disabled = true;

            // UI 업데이트: 아라 응답 준비 (빈 버블 생성)
            const araMessageDiv = addMessage('ara', '');
            let fullContent = "";

            try {
                // 2. 스트리밍 API 호출
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, message: message })
                });

                if (!response.ok) throw new Error("네트워크 응답에 문제가 있습니다.");

                // 3. ReadableStream 처리 로직
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");

                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            const jsonStr = line.substring(6);
                            try {
                                const data = JSON.parse(jsonStr);
                                if (data.content) {
                                    fullContent += data.content;
                                    araMessageDiv.innerText = fullContent; // 실시간 텍스트 주입
                                    scrollToBottom();
                                }
                            } catch (e) { console.error("JSON 파싱 에러:", e); }
                        }
                    }
                }
            } catch (error) {
                araMessageDiv.innerText = "미안해 선장님, 통신 중에 파도가 좀 세네. 다시 한번 말해줄래?";
            } finally {
                input.disabled = false;
                btn.disabled = false;
                input.focus();
            }
        }

        function addMessage(sender, text) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerText = text;
            chatBox.appendChild(div);
            scrollToBottom();
            return div;
        }

        function scrollToBottom() {
            const chatBox = document.getElementById('chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>