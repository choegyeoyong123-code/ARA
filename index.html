<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•´ì–‘ëŒ€ AI ë¹„ì„œ ARA v2.0</title>
    <style>
        :root { --primary-color: #005eb8; --bg-color: #f4f7f6; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* ì±„íŒ… ì˜ì—­ */
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        
        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message { max-width: 80%; padding: 12px 16px; border-radius: 15px; line-height: 1.5; word-wrap: break-word; font-size: 15px; }
        .user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 2px; }
        .ara { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* í•˜ë‹¨ ì…ë ¥ì°½ ì˜ì—­ */
        .input-area { background: white; padding: 20px; display: flex; gap: 10px; border-top: 1px solid #ddd; z-index: 100; position: relative; }
        #chat-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        #chat-input:focus { border-color: var(--primary-color); }
        button { padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }

        /* [NEW] ARA Dock ìŠ¤íƒ€ì¼ (ì…ë ¥ì°½ ìœ„ì— ëœ¨ê²Œ ìˆ˜ì •ë¨: bottom 90px) */
        .ara-dock {
            position: fixed; 
            bottom: 90px; /* ì…ë ¥ì°½ ë†’ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ìœ„ë¡œ ì˜¬ë¦¼ */
            left: 50%; 
            transform: translateX(-50%);
            width: 90%; 
            max-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: flex; 
            justify-content: space-between;
            padding: 12px 20px; 
            z-index: 99; /* ì…ë ¥ì°½(100)ë³´ë‹¤ ì‚´ì§ ì•„ë˜ ë‘ê±°ë‚˜ ì¡°ì • ê°€ëŠ¥ */
            transition: bottom 0.3s ease;
        }
        .dock-item {
            text-align: center; 
            font-size: 11px; 
            color: #555; 
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .dock-icon { font-size: 18px; margin-bottom: 2px; }
        .dock-item:hover { transform: scale(1.1); transition: 0.2s; color: var(--primary-color); }
    </style>
</head>
<body>
    <div id="chat-box"></div>

    <div class="ara-dock">
        <div class="dock-item" onclick="sendMsg('190ë²ˆ ë²„ìŠ¤ ìœ„ì¹˜ ì•Œë ¤ì¤˜')">
            <span class="dock-icon">ğŸšŒ</span>
            <span>ë²„ìŠ¤</span>
        </div>
        <div class="dock-item" onclick="sendMsg('í•™êµ ê·¼ì²˜ ê°€ì„±ë¹„ ë§›ì§‘ ì¶”ì²œí•´ì¤˜')">
            <span class="dock-icon">ğŸ±</span>
            <span>ë§›ì§‘</span>
        </div>
        <div class="dock-item" onclick="sendMsg('ê·¼ì²˜ ë¬¸ ì—° ì•½êµ­ ì°¾ì•„ì¤˜')">
            <span class="dock-icon">ğŸ’Š</span>
            <span>ì•½êµ­</span>
        </div>
        <div class="dock-item" onclick="sendMsg('ì´ë²ˆ ì£¼ ë¶€ì‚° ì¶•ì œ ì •ë³´')">
            <span class="dock-icon">ğŸ‰</span>
            <span>ì¶•ì œ</span>
        </div>
        <div class="dock-item" onclick="sendMsg('ì§€ê¸ˆ í•™êµ ë‚ ì”¨ ì–´ë•Œ?')">
            <span class="dock-icon">ğŸŒ¤ï¸</span>
            <span>ë‚ ì”¨</span>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="chat-input" placeholder="ì„ ì¥ë‹˜, ê¶ê¸ˆí•œ ê²Œ ìˆìœ¼ì‹ ê°€ìš”?" onkeypress="if(event.keyCode==13) sendMessage()">
        <button id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <script>
        // [NEW] Dock ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ (ID ì„ íƒì ìˆ˜ì • ì™„ë£Œ)
        function sendMsg(msg) {
            const input = document.getElementById('chat-input');
            const btn = document.getElementById('send-btn');
            
            if(input && btn) { 
                input.value = msg; 
                btn.disabled = false; // í˜¹ì‹œ ë¹„í™œì„±í™” ìƒíƒœë¼ë©´ í•´ì œ
                btn.click(); // ì „ì†¡ ë²„íŠ¼ í´ë¦­ íŠ¸ë¦¬ê±°
            }
        }

        // --- ê¸°ì¡´ ë¡œì§ ---
        
        // 1. ì„¸ì…˜ ìœ ì§€
        let sessionId = sessionStorage.getItem('ara_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('ara_session_id', sessionId);
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const btn = document.getElementById('send-btn');
            const message = input.value.trim();
            if (!message) return;

            // UI ì—…ë°ì´íŠ¸: ì‚¬ìš©ì ë©”ì‹œì§€
            addMessage('user', message);
            input.value = '';
            input.disabled = true;
            btn.disabled = true;

            // UI ì—…ë°ì´íŠ¸: ì•„ë¼ ì‘ë‹µ ì¤€ë¹„
            const araMessageDiv = addMessage('ara', '');
            let fullContent = "";

            try {
                // 2. ìŠ¤íŠ¸ë¦¬ë° API í˜¸ì¶œ
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, message: message })
                });

                if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.");

                // 3. ReadableStream ì²˜ë¦¬ ë¡œì§
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");

                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            const jsonStr = line.substring(6);
                            try {
                                const data = JSON.parse(jsonStr);
                                if (data.content) {
                                    fullContent += data.content;
                                    araMessageDiv.innerText = fullContent;
                                    scrollToBottom();
                                }
                            } catch (e) { console.error("JSON íŒŒì‹± ì—ëŸ¬:", e); }
                        }
                    }
                }
            } catch (error) {
                araMessageDiv.innerText = "ë¯¸ì•ˆí•´ ì„ ì¥ë‹˜, í†µì‹  ì¤‘ì— íŒŒë„ê°€ ì¢€ ì„¸ë„¤. ë‹¤ì‹œ í•œë²ˆ ë§í•´ì¤„ë˜?";
            } finally {
                input.disabled = false;
                btn.disabled = false;
                input.focus();
            }
        }

        function addMessage(sender, text) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerText = text;
            chatBox.appendChild(div);
            scrollToBottom();
            return div;
        }

        function scrollToBottom() {
            const chatBox = document.getElementById('chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>